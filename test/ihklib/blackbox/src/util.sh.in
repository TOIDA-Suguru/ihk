function patch_and_build()
{
    fn_mckernel=$1
    fn_ihk=$2

    if [ -n $fn_mckernel ]; then
	pushd @WITH_MCK_SRC@
        patch -p1 < @CMAKE_INSTALL_PREFIX@/bin/${fn_mckernel}.patch
	popd
    fi

    if [ -n $fn_ihk ]; then
	pushd @WITH_MCK_SRC@/ihk
        patch -p1 < @CMAKE_INSTALL_PREFIX@/bin/${fn_ihk}.patch
	popd
    fi

    pushd /tmp
        rm -rf build
        mkdir build
        cd build
        cmake @WITH_MCK_SRC@ -DCMAKE_INSTALL_PREFIX=@WITH_MCK@
        make -j install
    popd

    if [ -n $fn_mckernel ]; then
	pushd @WITH_MCK_SRC@
        patch -R -p1 < @CMAKE_INSTALL_PREFIX@/bin/${fn_mckernel}.patch
	popd
    fi

    if [ -n $fn_ihk ]; then
	pushd @WITH_MCK_SRC@/ihk
        patch -R -p1 < @CMAKE_INSTALL_PREFIX@/bin/${fn_ihk}.patch
        popd
    fi
}

function detect_cpu_model()
{
    implementer=$(gawk '/CPU implementer/ { print $4; exit; }' /proc/cpuinfo)
    arch=$(gawk '/CPU architecture/ { print $3; exit; }' /proc/cpuinfo)
    var=$(gawk '/CPU variant/ { print $4; exit; }' /proc/cpuinfo)
    part=$(gawk '/CPU part/ { print $4; exit; }' /proc/cpuinfo)

    if [[ "$implementer" == "0x46" ]] && [[ "$arch" == "8" ]] &&
	[[ "$var" == "0x0" ]] && [[ "$part" == "0x001" ]]; then
	cpu_model="a64fx"
    else
	cpu_model="unknown"
    fi
}
